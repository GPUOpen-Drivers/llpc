
; RUN: lgc %s -print-after=lgc-builder-replayer -o /dev/null 2>&1 - <%s | FileCheck --check-prefixes=CHECK %s

; CHECK: [[desc0:%[0-9]+]] = call i8 addrspace(4)* @lgc.descriptor.table.addr(i32 6
; CHECK: %{{.*}} = getelementptr i8, i8 addrspace(4)* [[desc0]], i32 16
; CHECK: call <2 x i32> @lgc.root.descriptor.v2i32(i32 6)
; CHECK: [[desc1:%[0-9]+]] = call i8 addrspace(4)* @lgc.descriptor.table.addr(i32 1
; CHECK: %{{.*}} = getelementptr i8, i8 addrspace(4)* [[desc1]], i32 32

; RUN: lgc -mcpu=gfx1030 -o - - <%s | FileCheck --check-prefixes=SHADER_TEST %s
; SHADER_TEST: s_load_dwordx8 [[desc:.*]], {{.*}}, 0x20
; SHADER_TEST: image_sample {{.*}}, {{.*}}, [[desc]], {{.*}} dmask:0xf
; SHADER_TEST: s_load_dwordx4 {{.*}}, {{.*}}, 0x10
; SHADER_TEST: .registers:
; SHADER_TEST: (SPI_SHADER_USER_DATA_PS_4): 0x6
; SHADER_TEST: (SPI_SHADER_USER_DATA_PS_5): 0x7

; ModuleID = 'lgcPipeline'
source_filename = "lgcPipeline"
target datalayout = "e-p:64:64-p1:64:64-p2:32:32-p3:32:32-p4:64:64-p5:32:32-p6:32:32-i64:64-v16:16-v24:32-v32:32-v48:64-v96:128-v192:256-v256:256-v512:512-v1024:1024-v2048:2048-n32:64-S32-A5-G1-ni:7"
target triple = "amdgcn--amdpal"

; Function Attrs: nounwind
define dllexport spir_func void @lgc.shader.VS.VSMain() local_unnamed_addr #0 !spirv.ExecutionModel !16 !lgc.shaderstage !17 {
.entry:
  ret void
}

; Function Attrs: nounwind
define dllexport spir_func void @lgc.shader.FS.PSMain() local_unnamed_addr #0 !spirv.ExecutionModel !18 !lgc.shaderstage !19 {
.entry:
  %0 = call i8 addrspace(7)* (...) @lgc.create.load.buffer.desc.p7i8(i32 -1610612736, i32 1, i32 0, i32 0)
  %1 = call {}* @llvm.invariant.start.p7i8(i64 -1, i8 addrspace(7)* %0)
  %2 = call i8 addrspace(7)* (...) @lgc.create.load.buffer.desc.p7i8(i32 -536870912, i32 1, i32 0, i32 2)
  %3 = call <2 x float> (...) @lgc.create.read.generic.input.v2f32(i32 0, i32 0, i32 0, i32 0, i32 16, i32 undef)
  %4 = bitcast i8 addrspace(7)* %2 to float addrspace(7)*
  %5 = load float, float addrspace(7)* %4, align 4
  %6 = getelementptr inbounds i8, i8 addrspace(7)* %0, i64 64
  %7 = bitcast i8 addrspace(7)* %6 to float addrspace(7)*
  %8 = load float, float addrspace(7)* %7, align 4
  %9 = fmul reassoc nnan nsz arcp contract afn float %5, %8
  %10 = call <8 x i32> addrspace(4)* (...) @lgc.create.get.desc.ptr.p4v8i32(i32 1, i32 -1073741824, i32 1)
  %11 = call i32 (...) @lgc.create.get.desc.stride.i32(i32 1, i32 -1073741824, i32 1)
  %12 = load <8 x i32>, <8 x i32> addrspace(4)* %10, align 32
  %13 = call <4 x i32> addrspace(4)* (...) @lgc.create.get.desc.ptr.p4v4i32(i32 2, i32 -2147483648, i32 0)
  %14 = call i32 (...) @lgc.create.get.desc.stride.i32(i32 2, i32 -2147483648, i32 0)
  %15 = load <4 x i32>, <4 x i32> addrspace(4)* %13, align 16
  %16 = call reassoc nnan nsz arcp contract afn <4 x float> (...) @lgc.create.image.sample.v4f32(i32 1, i32 512, <8 x i32> %12, <4 x i32> %15, i32 1, <2 x float> %3)
  %.splatinsert = insertelement <4 x float> poison, float %9, i64 0
  %17 = shufflevector <4 x float> %.splatinsert, <4 x float> poison, <4 x i32> zeroinitializer
  %scale = fmul reassoc nnan nsz arcp contract afn <4 x float> %16, %17
  call void (...) @lgc.create.write.generic.output(<4 x float> %scale, i32 0, i32 0, i32 0, i32 0, i32 0, i32 undef)
  ret void
}

; Function Attrs: nounwind readonly willreturn
declare i8 addrspace(7)* @lgc.create.load.buffer.desc.p7i8(...) local_unnamed_addr #1

; Function Attrs: argmemonly nocallback nofree nosync nounwind willreturn
declare {}* @llvm.invariant.start.p7i8(i64 immarg, i8 addrspace(7)* nocapture) #2

; Function Attrs: nounwind readonly willreturn
declare <2 x float> @lgc.create.read.generic.input.v2f32(...) local_unnamed_addr #1

; Function Attrs: nounwind readnone
declare <8 x i32> addrspace(4)* @lgc.create.get.desc.ptr.p4v8i32(...) local_unnamed_addr #3

; Function Attrs: nounwind readnone
declare i32 @lgc.create.get.desc.stride.i32(...) local_unnamed_addr #3

; Function Attrs: nounwind readnone
declare <4 x i32> addrspace(4)* @lgc.create.get.desc.ptr.p4v4i32(...) local_unnamed_addr #3

; Function Attrs: nounwind readonly willreturn
declare <4 x float> @lgc.create.image.sample.v4f32(...) local_unnamed_addr #1

; Function Attrs: nounwind
declare void @lgc.create.write.generic.output(...) local_unnamed_addr #0

attributes #0 = { nounwind }
attributes #1 = { nounwind readonly willreturn }
attributes #2 = { argmemonly nocallback nofree nosync nounwind willreturn }
attributes #3 = { nounwind readnone }

!lgc.client = !{!0}
!lgc.options = !{!1}
!lgc.options.VS = !{!2}
!lgc.options.FS = !{!3}
!lgc.user.data.nodes = !{!4, !5, !6, !7, !8, !9, !10, !11, !12}
!lgc.color.export.formats = !{!13}
!lgc.input.assembly.state = !{!14}
!amdgpu.pal.metadata.msgpack = !{!15}

!0 = !{!"Vulkan"}
!1 = !{i32 -753554878, i32 248344356, i32 -1272835204, i32 -1818531522, i32 1, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 1, i32 0, i32 0, i32 2, i32 0, i32 0, i32 0, i32 1}
!2 = !{i32 -64684466, i32 1801624907, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 64, i32 0, i32 0, i32 3, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 20, i32 1800}
!3 = !{i32 -295196488, i32 -704705974, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 64, i32 0, i32 0, i32 3, i32 0, i32 0, i32 0, i32 0, i32 0, i32 0, i32 20, i32 1800}
!4 = !{!"DescriptorTableVaPtr", i32 0, i32 1, i32 1}
!5 = !{!"DescriptorBuffer", i32 0, i32 8, i32 -1610612736, i32 0, i32 4}
!6 = !{!"DescriptorTableVaPtr", i32 1, i32 1, i32 2}
!7 = !{!"DescriptorResource", i32 0, i32 16, i32 -1073741824, i32 0, i32 8}
!8 = !{!"DescriptorSampler", i32 16, i32 4, i32 -2147483648, i32 0, i32 4}
!9 = !{!"InlineBuffer", i32 2, i32 1, i32 -1610612736, i32 3, i32 4}
!10 = !{!"InlineBuffer", i32 3, i32 1, i32 -1610612736, i32 4, i32 4}
!11 = !{!"DescriptorBufferCompact", i32 4, i32 4, i32 -536870912, i32 0, i32 2}
!12 = !{!"IndirectUserDataVaPtr", i32 7, i32 1, i32 0}
!13 = !{i32 16}
!14 = !{i32 3, i32 3}
!15 = !{!"\82\B0amdpal.pipelines\91\84\AA.registers\80\B0.spill_threshold\CE\FF\FF\FF\FF\B0.user_data_limit\00\AF.xgl_cache_info\82\B3.128_bit_cache_hash\92\CF\D1[\149Mh\C7\B4\CF\B9Z^Uh\E4Zq\AD.llpc_version\A453.5\AEamdpal.version\92\02\03"}
!16 = !{i32 0}
!17 = !{i32 1}
!18 = !{i32 4}
!19 = !{i32 6}
