; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --tool lgc
; RUN: lgc -mcpu=gfx1010 -o - -use-gpu-divergence-analysis -passes='require<lgc-pipeline-state>,function(lgc-patch-buffer-op)' -enable-opaque-pointers %s | FileCheck --check-prefixes=CHECK %s

; Test that @llvm.amdgcn.s.buffer.load.imm.i32 with non-zero immediate offset gets generated.
; Offset 10 is equal to offset (1, 2) inside %llpc.array.element.1: 2 * 4 + 2 * 1.

%llpc.array.element.1 = type <{ [2 x float], [8 x i8] }>

; Function Attrs: nounwind
define dllexport spir_func float @lgc.shader.CS.main(<4 x i32> inreg %desc, i32 inreg %nonConstOffset) local_unnamed_addr #0 !lgc.shaderstage !0 {
; CHECK-LABEL: @lgc.shader.CS.main(
; CHECK-NEXT:  .entry:
; CHECK-NEXT:    [[TMP0:%.*]] = sext i32 [[NONCONSTOFFSET:%.*]] to i64
; CHECK-NEXT:    [[TMP1:%.*]] = getelementptr <{ [8 x i8], [8 x %llpc.array.element.1] }>, ptr addrspace(6) null, i64 0, i32 1, i64 [[TMP0]]
; CHECK-NEXT:    [[TMP2:%.*]] = ptrtoint ptr addrspace(6) [[TMP1]] to i32
; CHECK-NEXT:    [[TMP3:%.*]] = getelementptr <{ [8 x i8], [8 x %llpc.array.element.1] }>, ptr addrspace(6) null, i64 0, i32 1, i64 [[TMP0]], i32 1, i64 2
; CHECK-NEXT:    [[TMP4:%.*]] = ptrtoint ptr addrspace(6) [[TMP3]] to i32
; CHECK-NEXT:    [[TMP5:%.*]] = call i32 @llvm.amdgcn.s.buffer.load.imm.i32(<4 x i32> zeroinitializer, i32 [[TMP2]], i32 10, i32 0), !invariant.load !1
; CHECK-NEXT:    [[TMP6:%.*]] = bitcast i32 [[TMP5]] to float
; CHECK-NEXT:    ret float [[TMP6]]
;
.entry:
  %fat = call ptr addrspace(7) @lgc.late.launder.fat.pointer(<4 x i32> zeroinitializer)
  %inv = call ptr @llvm.invariant.start.p7(i64 -1, ptr addrspace(7) %fat)
  %0 = sext i32 %nonConstOffset to i64
  %gep = getelementptr <{ [8 x i8], [8 x %llpc.array.element.1] }>, ptr addrspace(7) %fat, i64 0, i32 1, i64 %0, i32 1, i64 2
  %load = load float, ptr addrspace(7) %gep, align 4
  ret float %load
}


declare i8 addrspace(7)* @lgc.late.launder.fat.pointer(<4 x i32>)
declare {}* @llvm.invariant.start.p7(i64 immarg, ptr addrspace(7) nocapture)

!0 = !{i32 7}
