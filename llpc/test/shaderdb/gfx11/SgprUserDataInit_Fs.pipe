; NOTE: Assertions have been autogenerated by tool/update_llpc_test_checks.py UTC_ARGS: --check-pal-metadata
; Test to check that dummy sgpr user data registers are inserted when required
; This test checks wave32 fragment/pixel shaders

; RUN: amdllpc %gfxip -o - -filetype=asm %s | FileCheck -check-prefixes=CHECK %s

[Version]
version = 40

[VsSpirv]
               OpCapability Shader
          %1 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel Logical GLSL450
               OpEntryPoint Vertex %4 "main"
       %void = OpTypeVoid
          %3 = OpTypeFunction %void
          %4 = OpFunction %void None %3
          %5 = OpLabel
               OpReturn
               OpFunctionEnd

[VsInfo]
entryPoint = main

[FsSpirv]
               OpCapability Shader
          %1 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel Logical GLSL450
               OpEntryPoint Fragment %4 "main" %633
               OpExecutionMode %4 OriginUpperLeft
               OpDecorate %177 DescriptorSet 3
               OpDecorate %177 Binding 14
               OpDecorate %633 Location 0
       %void = OpTypeVoid
          %3 = OpTypeFunction %void
      %float = OpTypeFloat 32
    %v4float = OpTypeVector %float 4
    %v2float = OpTypeVector %float 2
       %uint = OpTypeInt 32 0
         %38 = OpTypeImage %float 2D 0 0 0 1 Unknown
%_ptr_UniformConstant_38 = OpTypePointer UniformConstant %38
         %40 = OpTypeSampler
     %uint_4 = OpConstant %uint 4
  %float_128 = OpConstant %float 128
        %101 = OpConstantComposite %v2float %float_128 %float_128
        %117 = OpTypeSampledImage %38
    %float_0 = OpConstant %float 0
        %int = OpTypeInt 32 1
      %int_0 = OpConstant %int 0
      %int_3 = OpConstant %int 3
       %bool = OpTypeBool
%_arr_38_uint_4 = OpTypeArray %38 %uint_4
%_ptr_UniformConstant__arr_38_uint_4 = OpTypePointer UniformConstant %_arr_38_uint_4
        %177 = OpVariable %_ptr_UniformConstant__arr_38_uint_4 UniformConstant
        %591 = OpConstantComposite %v4float %float_0 %float_0 %float_0 %float_0
%_ptr_Output_v4float = OpTypePointer Output %v4float
        %633 = OpVariable %_ptr_Output_v4float Output
       %1285 = OpUndef %40
          %4 = OpFunction %void None %3
          %5 = OpLabel
               OpBranch %998
        %998 = OpLabel
       %1222 = OpPhi %v4float %591 %5 %1026 %1002
       %1221 = OpPhi %int %int_0 %5 %int_3 %1002
       %1001 = OpSLessThan %bool %1221 %int_3
               OpLoopMerge %1030 %1002 None
               OpBranchConditional %1001 %1002 %1030
       %1002 = OpLabel
       %1005 = OpAccessChain %_ptr_UniformConstant_38 %177 %int_3
       %1006 = OpLoad %38 %1005
       %1008 = OpSampledImage %117 %1006 %1285
       %1012 = OpImageSampleImplicitLod %v4float %1008 %101
       %1026 = OpExtInst %v4float %1 FMix %591 %1012 %1012
               OpBranch %998
       %1030 = OpLabel
               OpStore %633 %1222
               OpReturn
               OpFunctionEnd

[FsInfo]
entryPoint = main
userDataNode[0].type = DescriptorTableVaPtr
userDataNode[0].offsetInDwords = 18
userDataNode[0].sizeInDwords = 1
userDataNode[0].next[0].type = DescriptorResource
userDataNode[0].next[0].offsetInDwords = 72
userDataNode[0].next[0].sizeInDwords = 32
userDataNode[0].next[0].set = 3
userDataNode[0].next[0].binding = 14
options.waveSize = 32


[GraphicsPipelineState]
colorBuffer[0].format = VK_FORMAT_R8G8B8A8_SRGB
colorBuffer[0].channelWriteMask = 15
colorBuffer[0].blendEnable = 0
colorBuffer[0].blendSrcAlphaToColor = 0
; CHECK-LABEL: amdgpu_gs_main:
; CHECK:         s_mov_b64 exec, -1
; CHECK-NEXT:    v_mbcnt_lo_u32_b32 v1, -1, 0
; CHECK-NEXT:    s_lshr_b32 s0, s3, 18
; CHECK-NEXT:    s_delay_alu instid0(SALU_CYCLE_1) | instskip(NEXT) | instid1(VALU_DEP_1)
; CHECK-NEXT:    s_and_b32 s0, s0, 0x3c0
; CHECK-NEXT:    v_mbcnt_hi_u32_b32 v1, -1, v1
; CHECK-NEXT:    s_delay_alu instid0(VALU_DEP_1)
; CHECK-NEXT:    v_add_nc_u32_e32 v1, s0, v1
; CHECK-NEXT:    s_bfe_u32 s0, s2, 0x90016
; CHECK-NEXT:    s_delay_alu instid0(VALU_DEP_1) | instid1(SALU_CYCLE_1)
; CHECK-NEXT:    v_cmp_gt_u32_e32 vcc, s0, v1
; CHECK-NEXT:    s_and_saveexec_b64 s[0:1], vcc
; CHECK-NEXT:    s_cbranch_execz .LBB0_2
; CHECK-NEXT:    exp prim v0, off, off, off done
; CHECK-NEXT:  .LBB0_2:
; CHECK-NEXT:    s_waitcnt expcnt(0)
; CHECK-NEXT:    s_or_b64 exec, exec, s[0:1]
; CHECK-NEXT:    s_bfe_u32 s0, s2, 0x9000c
; CHECK-NEXT:    s_delay_alu instid0(SALU_CYCLE_1)
; CHECK-NEXT:    v_cmp_gt_u32_e32 vcc, s0, v1
; CHECK-NEXT:    s_and_saveexec_b64 s[0:1], vcc
; CHECK-NEXT:    s_cbranch_execz .LBB0_4
; CHECK-NEXT:    v_mov_b32_e32 v0, 1.0
; CHECK-NEXT:    v_mov_b32_e32 v1, 0
; CHECK-NEXT:    exp pos0 v1, v1, v1, v0 done
; CHECK-NEXT:  .LBB0_4:
; CHECK-NEXT:    s_endpgm
;
; CHECK-LABEL: amdgpu_ps_main:
; CHECK:         s_getpc_b64 s[2:3]
; CHECK-NEXT:    s_mov_b32 s8, exec_lo
; CHECK-NEXT:    s_mov_b32 s0, s1
; CHECK-NEXT:    s_mov_b32 s1, s3
; CHECK-NEXT:    s_wqm_b32 exec_lo, exec_lo
; CHECK-NEXT:    s_load_b256 s[0:7], s[0:1], 0x180
; CHECK-NEXT:    v_mov_b32_e32 v0, 0x58005800
; CHECK-NEXT:    s_and_b32 exec_lo, exec_lo, s8
; CHECK-NEXT:    s_waitcnt lgkmcnt(0)
; CHECK-NEXT:    image_sample v[0:3], v0, s[0:7], s[0:3] dmask:0xf dim:SQ_RSRC_IMG_2D a16
; CHECK-NEXT:    s_waitcnt vmcnt(0)
; CHECK-NEXT:    v_dual_mul_f32 v0, v0, v0 :: v_dual_mul_f32 v1, v1, v1
; CHECK-NEXT:    v_dual_mul_f32 v2, v2, v2 :: v_dual_mul_f32 v3, v3, v3
; CHECK-NEXT:    s_delay_alu instid0(VALU_DEP_2) | instskip(NEXT) | instid1(VALU_DEP_2)
; CHECK-NEXT:    v_cvt_pk_rtz_f16_f32_e32 v0, v0, v1
; CHECK-NEXT:    v_cvt_pk_rtz_f16_f32_e32 v1, v2, v3
; CHECK-NEXT:    exp mrt0 v0, v1, off, off done
; CHECK-NEXT:    s_endpgm
;
; CHECK-LABEL: .amdgpu_pal_metadata
; CHECK-NEXT: ---
; CHECK-NEXT: amdpal.pipelines:
; CHECK-NEXT:   - .api:            Vulkan
; CHECK-NEXT:     .graphics_registers:
; CHECK-NEXT:       .aa_coverage_to_shader_select: InputCoverage
; CHECK-NEXT:       .cb_shader_mask:
; CHECK-NEXT:         .output0_enable: 0xf
; CHECK-NEXT:         .output1_enable: 0
; CHECK-NEXT:         .output2_enable: 0
; CHECK-NEXT:         .output3_enable: 0
; CHECK-NEXT:         .output4_enable: 0
; CHECK-NEXT:         .output5_enable: 0
; CHECK-NEXT:         .output6_enable: 0
; CHECK-NEXT:         .output7_enable: 0
; CHECK-NEXT:       .db_shader_control:
; CHECK-NEXT:         .alpha_to_mask_disable: true
; CHECK-NEXT:         .conservative_z_export: 0
; CHECK-NEXT:         .depth_before_shader: 0
; CHECK-NEXT:         .exec_on_hier_fail: false
; CHECK-NEXT:         .exec_on_noop:   false
; CHECK-NEXT:         .kill_enable:    false
; CHECK-NEXT:         .mask_export_enable: false
; CHECK-NEXT:         .pre_shader_depth_coverage_enable: 0
; CHECK-NEXT:         .stencil_test_val_export_enable: 0
; CHECK-NEXT:         .z_export_enable: 0
; CHECK-NEXT:         .z_order:        0x1
; CHECK-NEXT:       .es_vgpr_comp_cnt: 0
; CHECK-NEXT:       .ge_ngg_subgrp_cntl:
; CHECK-NEXT:         .prim_amp_factor: 0x1
; CHECK-NEXT:         .threads_per_subgroup: 0x100
; CHECK-NEXT:       .gs_vgpr_comp_cnt: 0x1
; CHECK-NEXT:       .ia_multi_vgt_param_piped:
; CHECK-NEXT:         .primgroup_size: 0x7f
; CHECK-NEXT:       .max_verts_per_subgroup: 0x80
; CHECK-NEXT:       .pa_cl_clip_cntl:
; CHECK-NEXT:         .dx_linear_attr_clip_ena: true
; CHECK-NEXT:         .rasterization_kill: false
; CHECK-NEXT:         .vte_vport_provoke_disable: false
; CHECK-NEXT:       .pa_cl_vte_cntl:
; CHECK-NEXT:         .vtx_w0_fmt:     true
; CHECK-NEXT:         .x_offset_ena:   true
; CHECK-NEXT:         .x_scale_ena:    true
; CHECK-NEXT:         .y_offset_ena:   true
; CHECK-NEXT:         .y_scale_ena:    true
; CHECK-NEXT:         .z_offset_ena:   true
; CHECK-NEXT:         .z_scale_ena:    true
; CHECK-NEXT:       .pa_su_vtx_cntl:
; CHECK-NEXT:         .pix_center:     0x1
; CHECK-NEXT:         .quant_mode:     0x5
; CHECK-NEXT:         .round_mode:     0x2
; CHECK-NEXT:       .ps_extra_lds_size: 0
; CHECK-NEXT:       .ps_iter_sample: false
; CHECK-NEXT:       .spi_baryc_cntl:
; CHECK-NEXT:         .front_face_all_bits: true
; CHECK-NEXT:         .pos_float_location: 0
; CHECK-NEXT:       .spi_ps_in_control:
; CHECK-NEXT:         .num_interps:    0
; CHECK-NEXT:         .ps_w32_en:      true
; CHECK-NEXT:       .spi_ps_input_addr:
; CHECK-NEXT:         .ancillary_ena:  false
; CHECK-NEXT:         .front_face_ena: false
; CHECK-NEXT:         .line_stipple_tex_ena: false
; CHECK-NEXT:         .linear_center_ena: false
; CHECK-NEXT:         .linear_centroid_ena: false
; CHECK-NEXT:         .linear_sample_ena: false
; CHECK-NEXT:         .persp_center_ena: false
; CHECK-NEXT:         .persp_centroid_ena: false
; CHECK-NEXT:         .persp_pull_model_ena: false
; CHECK-NEXT:         .persp_sample_ena: true
; CHECK-NEXT:         .pos_fixed_pt_ena: false
; CHECK-NEXT:         .pos_w_float_ena: false
; CHECK-NEXT:         .pos_x_float_ena: false
; CHECK-NEXT:         .pos_y_float_ena: false
; CHECK-NEXT:         .pos_z_float_ena: false
; CHECK-NEXT:         .sample_coverage_ena: false
; CHECK-NEXT:       .spi_ps_input_cntl:
; CHECK-NEXT:         - .attr0_valid:    0
; CHECK-NEXT:           .attr1_valid:    0
; CHECK-NEXT:           .flat_shade:     false
; CHECK-NEXT:           .fp16_interp_mode: false
; CHECK-NEXT:           .offset:         0
; CHECK-NEXT:           .prim_attr:      false
; CHECK-NEXT:           .pt_sprite_tex:  false
; CHECK-NEXT:       .spi_ps_input_ena:
; CHECK-NEXT:         .ancillary_ena:  false
; CHECK-NEXT:         .front_face_ena: false
; CHECK-NEXT:         .line_stipple_tex_ena: false
; CHECK-NEXT:         .linear_center_ena: false
; CHECK-NEXT:         .linear_centroid_ena: false
; CHECK-NEXT:         .linear_sample_ena: false
; CHECK-NEXT:         .persp_center_ena: false
; CHECK-NEXT:         .persp_centroid_ena: false
; CHECK-NEXT:         .persp_pull_model_ena: false
; CHECK-NEXT:         .persp_sample_ena: true
; CHECK-NEXT:         .pos_fixed_pt_ena: false
; CHECK-NEXT:         .pos_w_float_ena: false
; CHECK-NEXT:         .pos_x_float_ena: false
; CHECK-NEXT:         .pos_y_float_ena: false
; CHECK-NEXT:         .pos_z_float_ena: false
; CHECK-NEXT:         .sample_coverage_ena: false
; CHECK-NEXT:       .spi_shader_col_format:
; CHECK-NEXT:         .col_0_export_format: 0x4
; CHECK-NEXT:         .col_1_export_format: 0
; CHECK-NEXT:         .col_2_export_format: 0
; CHECK-NEXT:         .col_3_export_format: 0
; CHECK-NEXT:         .col_4_export_format: 0
; CHECK-NEXT:         .col_5_export_format: 0
; CHECK-NEXT:         .col_6_export_format: 0
; CHECK-NEXT:         .col_7_export_format: 0
; CHECK-NEXT:       .spi_shader_idx_format: 0x1
; CHECK-NEXT:       .spi_shader_pos_format:
; CHECK-NEXT:         - 0x4
; CHECK-NEXT:         - 0
; CHECK-NEXT:         - 0
; CHECK-NEXT:         - 0
; CHECK-NEXT:         - 0
; CHECK-NEXT:       .spi_shader_z_format: 0
; CHECK-NEXT:       .spi_vs_out_config:
; CHECK-NEXT:         .no_pc_export:   true
; CHECK-NEXT:       .vgt_esgs_ring_itemsize: 0x1
; CHECK-NEXT:       .vgt_gs_max_vert_out: 0x1
; CHECK-NEXT:       .vgt_gs_mode:
; CHECK-NEXT:         .es_write_optimize: false
; CHECK-NEXT:         .gs_write_optimize: true
; CHECK-NEXT:         .mode:           0x3
; CHECK-NEXT:         .onchip:         0x1
; CHECK-NEXT:       .vgt_gs_onchip_cntl:
; CHECK-NEXT:         .es_verts_per_subgroup: 0x80
; CHECK-NEXT:         .gs_inst_prims_per_subgrp: 0x80
; CHECK-NEXT:         .gs_prims_per_subgroup: 0x80
; CHECK-NEXT:       .vgt_gs_out_prim_type:
; CHECK-NEXT:         .outprim_type:   PointList
; CHECK-NEXT:       .vgt_gs_per_vs:  0x2
; CHECK-NEXT:       .vgt_gs_vert_itemsize: 0
; CHECK-NEXT:       .vgt_gsvs_ring_itemsize: 0
; CHECK-NEXT:       .vgt_reuse_off:  false
; CHECK-NEXT:       .vgt_shader_stages_en:
; CHECK-NEXT:         .es_stage_en:    0x2
; CHECK-NEXT:         .gs_w32_en:      false
; CHECK-NEXT:         .max_primgroup_in_wave: 0x2
; CHECK-NEXT:         .ngg_wave_id_en: false
; CHECK-NEXT:         .primgen_en:     true
; CHECK-NEXT:         .primgen_passthru_en: true
; CHECK-NEXT:         .primgen_passthru_no_msg: true
; CHECK-NEXT:         .vs_stage_en:    0
; CHECK-NEXT:     .hardware_stages:
; CHECK-NEXT:       .gs:
; CHECK-NEXT:         .checksum_value: 0x3e7a1455
; CHECK-NEXT:         .debug_mode:     false
; CHECK-NEXT:         .entry_point:    _amdgpu_gs_main
; CHECK-NEXT:         .float_mode:     0xc0
; CHECK-NEXT:         .ieee_mode:      false
; CHECK-NEXT:         .image_op:       false
; CHECK-NEXT:         .lds_size:       0
; CHECK-NEXT:         .mem_ordered:    true
; CHECK-NEXT:         .offchip_lds_en: false
; CHECK-NEXT:         .scratch_en:     false
; CHECK-NEXT:         .scratch_memory_size: 0
; CHECK-NEXT:         .sgpr_count:     0xc
; CHECK-NEXT:         .sgpr_limit:     0x6a
; CHECK-NEXT:         .trap_present:   0
; CHECK-NEXT:         .user_data_reg_map:
; CHECK-NEXT:           - 0x10000000
; CHECK-NEXT:           - 0x1000000a
; CHECK-NEXT:           - 0x10000003
; CHECK-NEXT:           - 0x10000004
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:         .user_sgprs:     0x4
; CHECK-NEXT:         .vgpr_count:     0x9
; CHECK-NEXT:         .vgpr_limit:     0x100
; CHECK-NEXT:         .wavefront_size: 0x40
; CHECK-NEXT:         .wgp_mode:       false
; CHECK-NEXT:       .ps:
; CHECK-NEXT:         .checksum_value: 0x2cbaf88c
; CHECK-NEXT:         .debug_mode:     false
; CHECK-NEXT:         .entry_point:    _amdgpu_ps_main
; CHECK-NEXT:         .float_mode:     0xc0
; CHECK-NEXT:         .ieee_mode:      false
; CHECK-NEXT:         .image_op:       true
; CHECK-NEXT:         .mem_ordered:    true
; CHECK-NEXT:         .scratch_en:     false
; CHECK-NEXT:         .scratch_memory_size: 0
; CHECK-NEXT:         .sgpr_count:     0x11
; CHECK-NEXT:         .sgpr_limit:     0x6a
; CHECK-NEXT:         .trap_present:   0
; CHECK-NEXT:         .user_data_reg_map:
; CHECK-NEXT:           - 0x10000000
; CHECK-NEXT:           - 0x12
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:           - 0xffffffff
; CHECK-NEXT:         .user_sgprs:     0x10
; CHECK-NEXT:         .uses_uavs:      false
; CHECK-NEXT:         .vgpr_count:     0x4
; CHECK-NEXT:         .vgpr_limit:     0x100
; CHECK-NEXT:         .wavefront_size: 0x20
; CHECK-NEXT:         .wgp_mode:       false
; CHECK-NEXT:         .writes_depth:   0
; CHECK-NEXT:         .writes_uavs:    false
; CHECK-NEXT:     .internal_pipeline_hash:
; CHECK-NEXT:       - 0x{{[0-9a-f]+}}
; CHECK-NEXT:       - 0x{{[0-9a-f]+}}
; CHECK-NEXT:     .nggSubgroupSize: 0x80
; CHECK-NEXT:     .num_interpolants: 0x1
; CHECK-NEXT:     .registers:      {}
; CHECK-NEXT:     .shaders:
; CHECK-NEXT:       .pixel:
; CHECK-NEXT:         .api_shader_hash:
; CHECK-NEXT:           - 0x{{[0-9a-f]+}}
; CHECK-NEXT:           - 0
; CHECK-NEXT:         .hardware_mapping:
; CHECK-NEXT:           - .ps
; CHECK-NEXT:       .vertex:
; CHECK-NEXT:         .api_shader_hash:
; CHECK-NEXT:           - 0x{{[0-9a-f]+}}
; CHECK-NEXT:           - 0
; CHECK-NEXT:         .hardware_mapping:
; CHECK-NEXT:           - .gs
; CHECK-NEXT:     .spill_threshold: 0xffffffff
; CHECK-NEXT:     .type:           Ngg
; CHECK-NEXT:     .user_data_limit: 0x13
; CHECK-NEXT:     .xgl_cache_info:
; CHECK-NEXT:       .128_bit_cache_hash:
; CHECK-NEXT:         - 0x{{[0-9a-f]+}}
; CHECK-NEXT:         - 0x{{[0-9a-f]+}}
; CHECK-NEXT:       .llpc_version: {{.*}}
; CHECK-NEXT: amdpal.version:
; CHECK-NEXT:   - 0x3
; CHECK-NEXT:   - 0
; CHECK-NEXT: ...
