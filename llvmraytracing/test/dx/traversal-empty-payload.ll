; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --include-generated-funcs --version 3
; RUN: opt --verify-each -passes='lower-raytracing-pipeline,lint,continuations-lint,remove-types-metadata' -S %s --lint-abort-on-error | FileCheck --check-prefix=EMPTYPAYLOAD %s
; RUN: opt --verify-each -passes='lower-raytracing-pipeline,lint,sroa,lint,lower-await,lint,coro-early,dxil-coro-split,coro-cleanup,lint,dxil-cleanup-continuations,lint,dxil-cont-post-process,lint,continuations-lint,remove-types-metadata' -S %s --lint-abort-on-error | FileCheck --check-prefix=EMPTYPAYLOAD-ALL %s

; Test that we handle empty payload without creating additional stores and loads.

target datalayout = "e-m:e-p:64:32-p20:32:32-p21:32:32-p32:32:32-i1:32-i8:8-i16:16-i32:32-i64:32-f16:16-f32:32-f64:32-v8:8-v16:16-v32:32-v48:32-v64:32-v80:32-v96:32-v112:32-v128:32-v144:32-v160:32-v176:32-v192:32-v208:32-v224:32-v240:32-v256:32-n8:16:32"

%struct.TraversalData = type { %struct.SystemData, i32 }
%struct.SystemData = type { %struct.DispatchSystemData, float }
%struct.DispatchSystemData = type { i32 }

!continuation.preservedPayloadRegisterCount = !{!8} ; EMPTY_PAYLOAD

declare !pointeetys !4 i32 @_cont_GetLocalRootIndex(%struct.DispatchSystemData*)

declare !pointeetys !6 i1 @_cont_ReportHit(%struct.TraversalData* %data, float %t, i32 %hitKind)

declare void @lgc.ilcps.continue(...)

declare void @lgc.ilcps.waitContinue(...)

declare i64 @lgc.cps.as.continuation.reference__i64(...) #3

; Function Attrs: alwaysinline nounwind
define void @_cont_Traversal(%struct.TraversalData %data) #1 !lgc.rt.shaderstage !7 {
  %1 = alloca %struct.TraversalData, align 8
  store %struct.TraversalData %data, ptr %1, align 4
  %2 = getelementptr inbounds %struct.TraversalData, ptr %1, i32 0, i32 1
  %3 = load i32, ptr %2, align 4
  %4 = icmp eq i32 %3, 0
  %5 = getelementptr inbounds %struct.TraversalData, ptr %1, i32 0, i32 0
  br i1 %4, label %9, label %6

6:                                                ; preds = %0
  %7 = load %struct.SystemData, ptr %5, align 4
  %8 = call i64 (...) @lgc.cps.as.continuation.reference__i64(ptr @_cont_Traversal)
  call void (...) @lgc.ilcps.waitContinue(i64 1, i64 -1, i32 0, i64 %8, %struct.SystemData %7)
  unreachable

9:                                                ; preds = %0
  %10 = load %struct.SystemData, ptr %5, align 4
  call void (...) @lgc.ilcps.waitContinue(i64 0, i64 -1, i32 2, i64 poison, %struct.SystemData %10)
  unreachable
}

attributes #0 = { nounwind "disable-tail-calls"="false" "less-precise-fpmad"="false" "no-frame-pointer-elim"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-realign-stack" "stack-protector-buffer-size"="0" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #1 = { "disable-tail-calls"="false" "less-precise-fpmad"="false" "no-frame-pointer-elim"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-realign-stack" "stack-protector-buffer-size"="0" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #2 = { nounwind }

!0 = !{!"function", i32 poison, !1}
!1 = !{i32 0, %struct.TraversalData poison}
!2 = !{!"function", i32 poison, !1, i32 poison}
!3 = !{!"function", !"void", !1, i32 poison, i32 poison}
!4 = !{%struct.DispatchSystemData poison}
!5 = !{i32 0, %struct.DispatchSystemData poison}
!6 = !{%struct.TraversalData poison}
!7 = !{i32 6}
!8 = !{i32 0}
; EMPTYPAYLOAD-LABEL: define %struct.TraversalData @_cont_Traversal(
; EMPTYPAYLOAD-SAME: i64 [[RETURNADDR:%.*]], [[STRUCT_TRAVERSALDATA:%.*]] [[TMP0:%.*]], [0 x i32] [[PADDING:%.*]], [0 x i32] [[PAYLOAD:%.*]]) #[[ATTR0:[0-9]+]] !lgc.rt.shaderstage [[META3:![0-9]+]] !continuation.registercount [[META0:![0-9]+]] !continuation [[META4:![0-9]+]] {
; EMPTYPAYLOAD-NEXT:    [[TMP2:%.*]] = alloca [[STRUCT_TRAVERSALDATA]], align 8
; EMPTYPAYLOAD-NEXT:    [[SYSTEM_DATA_ALLOCA:%.*]] = alloca [[STRUCT_TRAVERSALDATA]], align 8
; EMPTYPAYLOAD-NEXT:    [[PAYLOAD_SERIALIZATION_ALLOCA:%.*]] = alloca [0 x i32], align 4
; EMPTYPAYLOAD-NEXT:    store [[STRUCT_TRAVERSALDATA]] [[TMP0]], ptr [[SYSTEM_DATA_ALLOCA]], align 4
; EMPTYPAYLOAD-NEXT:    store [[STRUCT_TRAVERSALDATA]] [[TMP0]], ptr [[TMP2]], align 4
; EMPTYPAYLOAD-NEXT:    [[TMP3:%.*]] = getelementptr inbounds [[STRUCT_TRAVERSALDATA]], ptr [[TMP2]], i32 0, i32 1
; EMPTYPAYLOAD-NEXT:    [[TMP4:%.*]] = load i32, ptr [[TMP3]], align 4
; EMPTYPAYLOAD-NEXT:    [[TMP5:%.*]] = icmp eq i32 [[TMP4]], 0
; EMPTYPAYLOAD-NEXT:    [[TMP6:%.*]] = getelementptr inbounds [[STRUCT_TRAVERSALDATA]], ptr [[TMP2]], i32 0, i32 0
; EMPTYPAYLOAD-NEXT:    br i1 [[TMP5]], label [[TMP12:%.*]], label [[TMP7:%.*]]
; EMPTYPAYLOAD:       7:
; EMPTYPAYLOAD-NEXT:    [[TMP8:%.*]] = load [[STRUCT_SYSTEMDATA:%.*]], ptr [[TMP6]], align 4
; EMPTYPAYLOAD-NEXT:    [[TMP9:%.*]] = call i64 (...) @lgc.cps.as.continuation.reference__i64(ptr @_cont_Traversal)
; EMPTYPAYLOAD-NEXT:    [[TMP10:%.*]] = load [[STRUCT_TRAVERSALDATA]], ptr [[SYSTEM_DATA_ALLOCA]], align 4
; EMPTYPAYLOAD-NEXT:    call void (...) @lgc.cps.jump(i64 1, i32 -1, {} poison, i64 [[TMP9]], [[STRUCT_SYSTEMDATA]] [[TMP8]]), !continuation.registercount [[META0]], !waitmask [[META5:![0-9]+]]
; EMPTYPAYLOAD-NEXT:    unreachable
; EMPTYPAYLOAD:       11:
; EMPTYPAYLOAD-NEXT:    [[TMP13:%.*]] = load [[STRUCT_SYSTEMDATA]], ptr [[TMP6]], align 4
; EMPTYPAYLOAD-NEXT:    [[TMP14:%.*]] = load [[STRUCT_TRAVERSALDATA]], ptr [[SYSTEM_DATA_ALLOCA]], align 4
; EMPTYPAYLOAD-NEXT:    call void (...) @lgc.cps.jump(i64 0, i32 -1, {} poison, i64 poison, [[STRUCT_SYSTEMDATA]] [[TMP13]]), !continuation.registercount [[META0]], !waitmask [[META5]]
; EMPTYPAYLOAD-NEXT:    unreachable
;
;
; EMPTYPAYLOAD-ALL-LABEL: define void @_cont_Traversal(
; EMPTYPAYLOAD-ALL-SAME: i32 [[CSPINIT:%.*]], i64 [[RETURNADDR:%.*]], [[STRUCT_TRAVERSALDATA:%.*]] [[TMP0:%.*]], [0 x i32] [[PADDING:%.*]], [0 x i32] [[PAYLOAD:%.*]]) #[[ATTR0:[0-9]+]] !lgc.rt.shaderstage [[META3:![0-9]+]] !continuation.registercount [[META0:![0-9]+]] !continuation [[META4:![0-9]+]] {
; EMPTYPAYLOAD-ALL-NEXT:  AllocaSpillBB:
; EMPTYPAYLOAD-ALL-NEXT:    [[CSP:%.*]] = alloca i32, align 4
; EMPTYPAYLOAD-ALL-NEXT:    store i32 [[CSPINIT]], ptr [[CSP]], align 4
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_0_0_EXTRACT:%.*]] = extractvalue [[STRUCT_TRAVERSALDATA]] [[TMP0]], 0, 0, 0
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_1_EXTRACT:%.*]] = extractvalue [[STRUCT_TRAVERSALDATA]] [[TMP0]], 0, 1
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_1_EXTRACT:%.*]] = extractvalue [[STRUCT_TRAVERSALDATA]] [[TMP0]], 1
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_0_0_EXTRACT15:%.*]] = extractvalue [[STRUCT_TRAVERSALDATA]] [[TMP0]], 0, 0, 0
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_1_EXTRACT16:%.*]] = extractvalue [[STRUCT_TRAVERSALDATA]] [[TMP0]], 0, 1
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_1_EXTRACT17:%.*]] = extractvalue [[STRUCT_TRAVERSALDATA]] [[TMP0]], 1
; EMPTYPAYLOAD-ALL-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[DOTFCA_1_EXTRACT17]], 0
; EMPTYPAYLOAD-ALL-NEXT:    br i1 [[TMP1]], label [[TMP7:%.*]], label [[TMP2:%.*]]
; EMPTYPAYLOAD-ALL:       2:
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_0_INSERT:%.*]] = insertvalue [[STRUCT_SYSTEMDATA:%.*]] poison, i32 [[DOTFCA_0_0_0_EXTRACT15]], 0, 0
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_1_INSERT19:%.*]] = insertvalue [[STRUCT_SYSTEMDATA]] [[DOTFCA_0_0_INSERT]], float [[DOTFCA_0_1_EXTRACT16]], 1
; EMPTYPAYLOAD-ALL-NEXT:    [[TMP3:%.*]] = call i64 @continuation.getAddrAndMD(ptr @_cont_Traversal)
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_0_0_INSERT:%.*]] = insertvalue [[STRUCT_TRAVERSALDATA]] poison, i32 [[DOTFCA_0_0_0_EXTRACT]], 0, 0, 0
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_1_INSERT:%.*]] = insertvalue [[STRUCT_TRAVERSALDATA]] [[DOTFCA_0_0_0_INSERT]], float [[DOTFCA_0_1_EXTRACT]], 0, 1
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_1_INSERT:%.*]] = insertvalue [[STRUCT_TRAVERSALDATA]] [[DOTFCA_0_1_INSERT]], i32 [[DOTFCA_1_EXTRACT]], 1
; EMPTYPAYLOAD-ALL-NEXT:    [[TMP6:%.*]] = load i32, ptr [[CSP]], align 4
; EMPTYPAYLOAD-ALL-NEXT:    call void (...) @lgc.ilcps.waitContinue(i64 1, i64 -1, i32 [[TMP6]], i64 [[TMP3]], [[STRUCT_SYSTEMDATA]] [[DOTFCA_1_INSERT19]])
; EMPTYPAYLOAD-ALL-NEXT:    unreachable
; EMPTYPAYLOAD-ALL:       5:
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_0_INSERT22:%.*]] = insertvalue [[STRUCT_SYSTEMDATA]] poison, i32 [[DOTFCA_0_0_0_EXTRACT15]], 0, 0
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_1_INSERT25:%.*]] = insertvalue [[STRUCT_SYSTEMDATA]] [[DOTFCA_0_0_INSERT22]], float [[DOTFCA_0_1_EXTRACT16]], 1
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_0_0_INSERT6:%.*]] = insertvalue [[STRUCT_TRAVERSALDATA]] poison, i32 [[DOTFCA_0_0_0_EXTRACT]], 0, 0, 0
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_0_1_INSERT9:%.*]] = insertvalue [[STRUCT_TRAVERSALDATA]] [[DOTFCA_0_0_0_INSERT6]], float [[DOTFCA_0_1_EXTRACT]], 0, 1
; EMPTYPAYLOAD-ALL-NEXT:    [[DOTFCA_1_INSERT12:%.*]] = insertvalue [[STRUCT_TRAVERSALDATA]] [[DOTFCA_0_1_INSERT9]], i32 [[DOTFCA_1_EXTRACT]], 1
; EMPTYPAYLOAD-ALL-NEXT:    [[TMP10:%.*]] = load i32, ptr [[CSP]], align 4
; EMPTYPAYLOAD-ALL-NEXT:    call void (...) @lgc.ilcps.waitContinue(i64 0, i64 -1, i32 [[TMP10]], i64 poison, [[STRUCT_SYSTEMDATA]] [[DOTFCA_1_INSERT25]])
; EMPTYPAYLOAD-ALL-NEXT:    unreachable
;
