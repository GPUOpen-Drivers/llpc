; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 3
; RUN: opt --verify-each -passes='dxil-cont-post-process,lint' -S %s 2>%t.stderr | FileCheck %s
; RUN: count 0 < %t.stderr

target datalayout = "e-m:e-p:64:32-p20:32:32-p21:32:32-i1:32-i8:8-i16:32-i32:32-i64:32-f16:32-f32:32-f64:32-v16:32-v32:32-v48:32-v64:32-v80:32-v96:32-v112:32-v128:32-v144:32-v160:32-v176:32-v192:32-v208:32-v224:32-v240:32-v256:32-n8:16:32"

%struct.DispatchSystemData = type { i32 }

declare i32 @continuation.initialContinuationStackPtr()
declare i32 @_cont_GetContinuationStackAddr()
declare i32 @_cont_GetLocalRootIndex(%struct.DispatchSystemData*)
declare %struct.DispatchSystemData @_cont_SetupRayGen()

define void @RayGen() !lgc.rt.shaderstage !5 !continuation.entry !0 !continuation !3 {
; CHECK-LABEL: define void @RayGen() !lgc.rt.shaderstage !3 !continuation.entry !4 !continuation !5 {
; CHECK-NEXT:    [[SYSTEM_DATA:%.*]] = alloca [[STRUCT_DISPATCHSYSTEMDATA:%.*]], align 8
; CHECK-NEXT:    [[CSP:%.*]] = alloca i32, align 4
; CHECK-NEXT:    [[TMP1:%.*]] = call [[STRUCT_DISPATCHSYSTEMDATA]] @_cont_SetupRayGen()
; CHECK-NEXT:    store [[STRUCT_DISPATCHSYSTEMDATA]] [[TMP1]], ptr [[SYSTEM_DATA]], align 4
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @_cont_GetContinuationStackAddr()
; CHECK-NEXT:    store i32 [[TMP2]], ptr [[CSP]], align 4
; CHECK-NEXT:    ret void
;
  %csp = alloca i32, align 4
  %cspInit = call i32 @continuation.initialContinuationStackPtr()
  store i32 %cspInit, i32* %csp
  ret void
}

define void @RayGen.resume.0(i32 %0, %struct.DispatchSystemData %1) !lgc.rt.shaderstage !5 !continuation !3 {
; CHECK-LABEL: define void @RayGen.resume.0(
; CHECK-SAME: i32 [[TMP0:%.*]], [[STRUCT_DISPATCHSYSTEMDATA:%.*]] [[TMP1:%.*]]) !lgc.rt.shaderstage !3 !continuation !5 {
; CHECK-NEXT:    [[SYSTEM_DATA:%.*]] = alloca [[STRUCT_DISPATCHSYSTEMDATA]], align 8
; CHECK-NEXT:    store [[STRUCT_DISPATCHSYSTEMDATA]] [[TMP1]], ptr [[SYSTEM_DATA]], align 4
; CHECK-NEXT:    ret void
;
  ret void
}

!dx.entryPoints = !{!1}
!continuation.stackAddrspace = !{!4}

!0 = !{}
!1 = !{void ()* @RayGen, !"RayGen", null, null, !2}
!2 = !{i32 8, i32 7}
!3 = !{void ()* @RayGen}
!4 = !{i32 21}
!5 = !{i32 0}
