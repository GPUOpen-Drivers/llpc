; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --function-signature --include-generated-funcs
; Test copying of fields between local and global payload whose size
; is not a multiple of i32s, requiring copies at a smaller granularity
; for at least a suffix of the fields.
; RUN: opt --opaque-pointers=0 --enforce-pointer-metadata=1 --verify-each -passes='add-types-metadata,dxil-cont-lgc-rt-op-converter,lint,lower-raytracing-pipeline,lint,remove-types-metadata' -S %s 2>%t.stderr | FileCheck -check-prefix=LOWERRAYTRACINGPIPELINE %s
; RUN: count 0 < %t.stderr

target datalayout = "e-m:e-p:64:32-p20:32:32-p21:32:32-i1:32-i8:8-i16:32-i32:32-i64:32-f16:32-f32:32-f64:32-v16:32-v32:32-v48:32-v64:32-v80:32-v96:32-v112:32-v128:32-v144:32-v160:32-v176:32-v192:32-v208:32-v224:32-v240:32-v256:32-n8:16:32"
; target triple = "dxil-ms-dx"

; The last two fields are relevant. The i16 needs special treatment,
; as well as the last two bytes of the <3 x i16>.
%struct.Payload = type { [5 x i32], i16, <3 x i16> }

; Function Attrs: nounwind
define void @Miss(%struct.Payload* noalias nocapture %payload) #0 {
  %1 = getelementptr inbounds %struct.Payload, %struct.Payload* %payload, i32 0, i32 1
  store i16 17, i16* %1, align 4
  ret void
}

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; BEGIN manually added gpurt content
%struct.HitData = type { float, i32 }
%struct.DispatchSystemData = type { i32 }
%struct.SystemData = type { %struct.DispatchSystemData }
%struct.TraversalData = type { %struct.SystemData }
%struct.AnyHitTraversalData = type { %struct.TraversalData, %struct.HitData }
%struct.BuiltInTriangleIntersectionAttributes = type { <2 x float> }
declare %struct.DispatchSystemData @_cont_SetupRayGen() #4
declare %struct.DispatchSystemData @_AmdAwaitTraversal(i64, %struct.TraversalData) #4
declare %struct.DispatchSystemData @_AmdAwaitShader(i64, %struct.DispatchSystemData) #4
declare %struct.AnyHitTraversalData @_AmdAwaitAnyHit(i64, %struct.AnyHitTraversalData, float, i32) #4
declare %struct.BuiltInTriangleIntersectionAttributes @_cont_GetTriangleHitAttributes(%struct.SystemData*) #4
declare void @_cont_SetTriangleHitAttributes(%struct.SystemData*, %struct.BuiltInTriangleIntersectionAttributes) #4
declare i1 @_cont_IsEndSearch(%struct.TraversalData*) #4
declare i32 @_cont_HitKind(%struct.SystemData* nocapture readnone %data, %struct.HitData*) #2
declare void @_AmdRestoreSystemData(%struct.DispatchSystemData* %data) #1
declare void @_AmdRestoreSystemDataAnyHit(%struct.AnyHitTraversalData* %data) #1

define i32 @_cont_GetLocalRootIndex(%struct.DispatchSystemData* %data) #4 {
  ret i32 5
}
; END manually added manually gpurt content
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

attributes #0 = { nounwind }
attributes #1 = { nounwind readnone }
attributes #2 = { nounwind readonly }
attributes #4 = { alwaysinline }

!llvm.ident = !{!0}
!dx.version = !{!1}
!dx.valver = !{!1}
!dx.shaderModel = !{!2}
!dx.typeAnnotations = !{!3}
!dx.dxrPayloadAnnotations = !{!8}
!dx.entryPoints = !{!12, !14}

!0 = !{!"dxcoob 2019.05.00"}
!1 = !{i32 1, i32 7}
!2 = !{!"lib", i32 6, i32 7}
!3 = !{i32 1, void (%struct.Payload*)* @Miss, !4}
!4 = !{!5, !7}
!5 = !{i32 1, !6, !6}
!6 = !{}
!7 = !{i32 2, !6, !6}
!8 = !{i32 0, %struct.Payload undef, !9}
!9 = !{!10, !11, !11}
!10 = !{i32 0, i32 259}
!11 = !{i32 0, i32 513}
!12 = !{null, !"", null, null, !13}
!13 = !{i32 0, i64 32}
!14 = !{void (%struct.Payload*)* @Miss, !"Miss", null, null, !15}
!15 = !{i32 8, i32 11, i32 6, i32 24, i32 5, !16}
!16 = !{i32 0}

; LOWERRAYTRACINGPIPELINE-LABEL: define {{[^@]+}}@Miss
; LOWERRAYTRACINGPIPELINE-SAME: ([[STRUCT_SYSTEMDATA:%.*]] [[TMP0:%.*]]) #[[ATTR0:[0-9]+]] !continuation.registercount !20 !continuation !21 {
; LOWERRAYTRACINGPIPELINE-NEXT:    [[SYSTEM_DATA_ALLOCA:%.*]] = alloca [[STRUCT_SYSTEMDATA]], align 8
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP2:%.*]] = alloca [[STRUCT_PAYLOAD:%.*]], align 8
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP3:%.*]] = call [[STRUCT_SYSTEMDATA]] @continuations.getSystemData.s_struct.SystemDatas()
; LOWERRAYTRACINGPIPELINE-NEXT:    store [[STRUCT_SYSTEMDATA]] [[TMP3]], %struct.SystemData* [[SYSTEM_DATA_ALLOCA]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP4:%.*]] = getelementptr inbounds [[STRUCT_SYSTEMDATA]], %struct.SystemData* [[SYSTEM_DATA_ALLOCA]], i32 0, i32 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[LOCAL_ROOT_INDEX:%.*]] = call i32 @_cont_GetLocalRootIndex(%struct.DispatchSystemData* [[TMP4]])
; LOWERRAYTRACINGPIPELINE-NEXT:    call void @amd.dx.setLocalRootIndex(i32 [[LOCAL_ROOT_INDEX]])
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP5:%.*]] = getelementptr inbounds [[STRUCT_PAYLOAD]], %struct.Payload* [[TMP2]], i32 0, i32 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP6:%.*]] = bitcast [5 x i32]* [[TMP5]] to i32*
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP7:%.*]] = getelementptr i32, i32* [[TMP6]], i32 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP8:%.*]] = getelementptr i32, i32* [[TMP7]], i64 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP9:%.*]] = load i32, i32* getelementptr inbounds ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_4_MISS_IN:%.*]], %struct.Payload.attr_max_8_i32s.layout_4_miss_in* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_4_miss_in*), i32 0, i32 0, i32 0), align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    store i32 [[TMP9]], i32* [[TMP8]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP10:%.*]] = getelementptr i32, i32* [[TMP6]], i32 1
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP11:%.*]] = getelementptr i32, i32* [[TMP10]], i64 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP12:%.*]] = load i32, i32* getelementptr inbounds ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_4_MISS_IN]], %struct.Payload.attr_max_8_i32s.layout_4_miss_in* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_4_miss_in*), i32 0, i32 0, i32 7), align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    store i32 [[TMP12]], i32* [[TMP11]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP13:%.*]] = getelementptr i32, i32* [[TMP10]], i64 1
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP14:%.*]] = load i32, i32* getelementptr ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_4_MISS_IN]], %struct.Payload.attr_max_8_i32s.layout_4_miss_in* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_4_miss_in*), i32 0, i32 0, i64 8), align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    store i32 [[TMP14]], i32* [[TMP13]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP15:%.*]] = getelementptr i32, i32* [[TMP10]], i64 2
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP16:%.*]] = load i32, i32* getelementptr ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_4_MISS_IN]], %struct.Payload.attr_max_8_i32s.layout_4_miss_in* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_4_miss_in*), i32 0, i32 0, i64 9), align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    store i32 [[TMP16]], i32* [[TMP15]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP17:%.*]] = getelementptr i32, i32* [[TMP10]], i64 3
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP18:%.*]] = load i32, i32* getelementptr ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_4_MISS_IN]], %struct.Payload.attr_max_8_i32s.layout_4_miss_in* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_4_miss_in*), i32 0, i32 0, i64 10), align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    store i32 [[TMP18]], i32* [[TMP17]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    call void (...) @registerbuffer.setpointerbarrier([30 x i32]* @PAYLOAD)
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP19:%.*]] = getelementptr inbounds [[STRUCT_PAYLOAD]], %struct.Payload* [[TMP2]], i32 0, i32 1
; LOWERRAYTRACINGPIPELINE-NEXT:    store i16 17, i16* [[TMP19]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    call void (...) @registerbuffer.setpointerbarrier([30 x i32]* @PAYLOAD)
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP20:%.*]] = getelementptr inbounds [[STRUCT_PAYLOAD]], %struct.Payload* [[TMP2]], i32 0, i32 1
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP21:%.*]] = bitcast i16* [[TMP20]] to i32*
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP22:%.*]] = getelementptr i32, i32* [[TMP21]], i32 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP23:%.*]] = getelementptr i32, i32* [[TMP22]], i64 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP24:%.*]] = bitcast i32* [[TMP23]] to %0*
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP25:%.*]] = load [[TMP0]], %0* [[TMP24]], align 1
; LOWERRAYTRACINGPIPELINE-NEXT:    store [[TMP0]] [[TMP25]], %0* bitcast (i32* getelementptr inbounds ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_6_MISS_OUT:%.*]], %struct.Payload.attr_max_8_i32s.layout_6_miss_out* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_6_miss_out*), i32 0, i32 0, i32 1) to %0*), align 1
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP26:%.*]] = getelementptr inbounds [[STRUCT_PAYLOAD]], %struct.Payload* [[TMP2]], i32 0, i32 2
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP27:%.*]] = bitcast <3 x i16>* [[TMP26]] to i32*
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP28:%.*]] = getelementptr i32, i32* [[TMP27]], i32 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP29:%.*]] = getelementptr i32, i32* [[TMP28]], i64 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP30:%.*]] = load i32, i32* [[TMP29]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    store i32 [[TMP30]], i32* getelementptr inbounds ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_6_MISS_OUT]], %struct.Payload.attr_max_8_i32s.layout_6_miss_out* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_6_miss_out*), i32 0, i32 0, i32 2), align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP31:%.*]] = getelementptr i32, i32* [[TMP28]], i64 1
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP32:%.*]] = bitcast i32* [[TMP31]] to %1*
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP33:%.*]] = load [[TMP1:%.*]], %1* [[TMP32]], align 1
; LOWERRAYTRACINGPIPELINE-NEXT:    store [[TMP1]] [[TMP33]], %1* bitcast (i32* getelementptr ([[STRUCT_PAYLOAD_ATTR_MAX_8_I32S_LAYOUT_6_MISS_OUT]], %struct.Payload.attr_max_8_i32s.layout_6_miss_out* bitcast ([30 x i32]* @PAYLOAD to %struct.Payload.attr_max_8_i32s.layout_6_miss_out*), i32 0, i32 0, i64 3) to %1*), align 1
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP34:%.*]] = getelementptr inbounds [[STRUCT_SYSTEMDATA]], %struct.SystemData* [[SYSTEM_DATA_ALLOCA]], i32 0, i32 0
; LOWERRAYTRACINGPIPELINE-NEXT:    [[TMP35:%.*]] = load [[STRUCT_DISPATCHSYSTEMDATA:%.*]], %struct.DispatchSystemData* [[TMP34]], align 4
; LOWERRAYTRACINGPIPELINE-NEXT:    ret [[STRUCT_DISPATCHSYSTEMDATA]] [[TMP35]], !continuation.registercount !20
;
;
; LOWERRAYTRACINGPIPELINE-LABEL: define {{[^@]+}}@_cont_GetLocalRootIndex
; LOWERRAYTRACINGPIPELINE-SAME: (%struct.DispatchSystemData* [[DATA:%.*]]) #[[ATTR1:[0-9]+]] {
; LOWERRAYTRACINGPIPELINE-NEXT:    ret i32 5
;
